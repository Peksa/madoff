*{ Display a receipt in one of several modes: 'teaser' or 'full' }*

<div class="receipt ${_as == 'teaser' ? 'teaser' : ''}">
	<h2 class="receipt title">
		<a href="@{Receipts.show(_receipt.id)}">${_receipt.title}</a>
	</h2>
	<div class="details">
		<span class="receipt-owner">by ${_receipt.owner.fullname}</span>,
		<span class="receipt-created">${_receipt.created.format('yyyy-MM-dd')}</span>
	</div>
	#{if _as != 'teaser'}
		<div class="receipt-content">
			<div class="about">Details:</div>
			${_receipt.description.nl2br()}
		</div>
	#{/if}
</div>

#{if _as == 'full'}
	<div class="members">
		<h3>
			${_receipt.members.size() ?: 'no'} 
	        member${_receipt.members.size().pluralize()}
		</h3>
	    #{list items:_receipt.members, as:'member'}
                <li class="member">
                    ${member.fullname}
                </li>
	    #{/list}
	</div>
	
	<div class="rounds">
		<h3>Receipt</h3>
		<table class="receipt" cellspacing="0">
			<tr>
				<th>Item</th><th>Special cases</th>
			</tr>
			#{list items:_receipt.subpots, as:'round'}
				<tr>
					<td>${round.description}</td>
					<td>
						#{list items:round.cases, as:'special'}
							${special.user.fullname}: ${special.amount} SEK
							<br/>
						#{/list}
						Rest: ${round.restAmount} SEK
					</td>
				</tr>
			#{/list}
		</table>
		<span class="total">Total: ${_receipt.total} SEK</span>
	</div>
		
	<div id="comments" class="comments">
	    <h3>
	        Comments:
	    </h3>

	</div>
	<h3>Add new comment</h3>
	
	<input type="text" id="comment-value" class="newComment"/>
	<input type="submit" id="postComment" value="Post" onsubmit="return false;"/>
#{/if}

<script type="text/javascript" charset="utf-8">
var lastTimestamp = 0
var imAVirgin = true;

$('#postComment').click(function() {
	$.post('@{Comments.post()}', {id: ${_receipt.id}, content: $('#comment-value').val(), lastPost: lastTimestamp}, renderPosts, 'json');
	return false;
})

$(document).ready(function() {
	getPosts();
	setInterval(getPosts, 10000);
});

function getPosts() {
	$.get('@{Comments.get()}', {id: ${_receipt.id}, lastPost: lastTimestamp}, renderPosts, 'json');
}

function renderPosts(comments) {
	$.each(comments, function(index,comment) {
		if(comment.timestamp > lastTimestamp) {
			lastTimestamp = Math.max(lastTimestamp,comment.timestamp);
		
			var template = '<div class="comment round gradient' + (comment.own === true ? ' own' : '') + '"><div class="comment-metadata' + (comment.own === true ? '-own' : '') + '"><span class="comment-poster">'
					+ comment.poster + '</span> says...</div><div class="comment-content">' + comment.content +
					'</div><span class="comment-date">Posted at ' + comment.date +
					' from web</span></div>';
		
			if(imAVirgin) {
				$(template).appendTo('#comments');
			} else {
				$(template)
				.hide()
				.appendTo('#comments')
				.fadeIn();
			}
		}
		
		//$('#comments').scrollBottom();
	});
	imAVirgin = false;
}

</script>